// --- AUTHENTICATION & SESSION ---
const user = JSON.parse(localStorage.getItem('currentUser'));
if (!user) { window.location.href = "login.html"; }
document.getElementById('welcomeUser').innerText = `Authorized Access: ${user.user}`;
if (user.role === 'admin') { document.getElementById('adminPanel').classList.remove('hidden-admin'); }

// --- TRADINGVIEW CHART ---
let tvWidget;
function loadChart(symbol = "FX:EURUSD") {
    tvWidget = new TradingView.widget({
        "autosize": true, "symbol": symbol, "interval": "60", "timezone": "Etc/UTC",
        "theme": "dark", "style": "1", "locale": "en", "container_id": "tradingview_widget",
        "backgroundColor": "rgba(2, 6, 23, 1)", "gridColor": "rgba(30, 41, 59, 1)"
    });
}
function changeSymbol(newSym) { loadChart(newSym); }
loadChart();

// --- REFINED ANALYTICS (Chart.js) ---
const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: { 
        y: { grid: { color: 'rgba(255,255,255,0.05)', drawBorder: false }, ticks: { color: '#64748b', font: { size: 10 } } },
        x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 10 } } }
    }
};

// 1. Refined Equity Curve
const performanceChart = new Chart(document.getElementById('performanceChart'), {
    type: 'line',
    data: { labels: ['W1', 'W2', 'W3', 'W4'], datasets: [{ data: [1000, 1200, 1150, 1400], borderColor: '#3b82f6', borderWidth: 2, tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)', pointRadius: 0 }] },
    options: chartOptions
});

// 2. Refined Bar Chart (Rounded)
const riskChart = new Chart(document.getElementById('riskChart'), {
    type: 'bar',
    data: { labels: ['M', 'T', 'W', 'T', 'F'], datasets: [{ data: [1, 2.5, 0.5, 3.2, 1.1], backgroundColor: '#ef4444', borderRadius: 4 }] },
    options: chartOptions
});

// 3. Refined Pie Chart
const pairPieChart = new Chart(document.getElementById('pairPieChart'), {
    type: 'doughnut',
    data: { labels: ['EURUSD', 'XAUUSD', 'GBPUSD'], datasets: [{ data: [40, 35, 25], backgroundColor: ['#3b82f6', '#f59e0b', '#8b5cf6'], borderWeight: 0, hoverOffset: 4 }] },
    options: { cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: '#64748b', usePointStyle: true, font: { size: 10 } } } } }
});

// --- TRADING ACTIONS ---
async function handleClose(accountId, positionId) {
    const lotInput = document.getElementById(`lots-${positionId}`);
    const volume = lotInput ? lotInput.value : null;
    
    if(!confirm(`Close ${volume ? volume + ' lots' : 'full position'}?`)) return;

    try {
        const response = await fetch('/api/closePosition', {
            method: 'POST',
            body: JSON.stringify({ accountId, positionId, volume })
        });
        if(response.ok) alert("Trade Closed Successfully");
        updateTerminal();
    } catch (err) { alert("Error closing trade"); }
}

// --- UPDATED TERMINAL (Removed ID, Added Buttons) ---
async function updateTerminal() {
    try {
        const res = await fetch('/api/getStats'); 
        const data = await res.json();
        const tableBody = document.getElementById('trader-rows');
        tableBody.innerHTML = '';
        
        data.forEach(item => {
            if (user.role === 'admin' || user.account === item.accountId) {
                const profitColor = item.profit >= 0 ? 'text-green-400' : 'text-red-400';
                tableBody.innerHTML += `
                    <tr class="hover:bg-white/5 transition border-b border-slate-800/50">
                        <td class="p-4"><span class="bg-slate-800 px-2 py-1 rounded text-[9px] text-slate-300">TRADER_${item.login || 'LIVE'}</span></td>
                        <td class="p-4 text-[10px] ${item.status === 'Online' ? 'text-green-500' : 'text-slate-500'}">‚óè ${item.status}</td>
                        <td class="p-4 font-bold">$${item.balance.toLocaleString()}</td>
                        <td class="p-4 text-slate-300">$${item.equity.toLocaleString()}</td>
                        <td class="p-4 text-right">
                            <div class="flex flex-col items-end">
                                <span class="font-black ${profitColor}">$${item.profit.toLocaleString()}</span>
                                <div class="flex gap-2 mt-2">
                                    <input id="lots-${item.positionId}" type="number" placeholder="Lots" class="w-16 bg-slate-900 border border-slate-700 rounded text-[9px] p-1">
                                    <button onclick="handleClose('${item.accountId}', '${item.positionId}')" class="bg-red-500/20 text-red-500 text-[9px] px-2 py-1 rounded font-bold hover:bg-red-500 hover:text-white transition">CLOSE</button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        });
    } catch (err) { console.error("Sync Error:", err); }
}

function logout() { localStorage.removeItem('currentUser'); window.location.href = "login.html"; }
updateTerminal();
setInterval(updateTerminal, 30000);
